<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>RVM Dashboard - Multi TPS</title>
  <style>
    body { font-family: Arial; background: #1e1e2f; color: white; text-align: center; margin: 0; padding: 0; }
    h1 { margin-top: 20px; }
    .container { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; margin: 20px; }
    .card {
      background: #2a2a40; padding: 20px; border-radius: 10px;
      width: 200px; box-sizing: border-box;
      display: flex; flex-direction: column; align-items: center;
    }
    .count { font-size: 48px; font-weight: bold; margin: 10px 0 20px 0; }
    button {
      background: #ff4d4d; border: none; padding: 10px 15px; font-size: 16px;
      color: white; cursor: pointer; border-radius: 5px; margin: 5px 0;
      width: 100%;
    }
    button:hover { background: #ff1a1a; }
    #history {
      margin: 30px auto; max-width: 800px; background: #2a2a40; padding: 20px; border-radius: 10px;
      color: white; text-align: left;
      overflow-x: auto;
    }
    table {
      border-collapse: collapse; width: 100%;
    }
    th, td {
      border: 1px solid #444; padding: 8px; text-align: center;
    }
    th { background: #3a3a58; }
  </style>
</head>
<body>
  <h1>TPS Bottle Counter Dashboard</h1>
  <div class="container" id="binsContainer">
    <!-- Bin cards inserted by JS -->
  </div>

  <div id="history">Select a bin's History to view here.</div>

<script>
  const API_URL = "https://tps-1.iffatadibamusaffa.workers.dev/"; // Your API endpoint for current counts
  const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbwQgdrKZGYozrcXNJTbIKTJ1gufmGuBfIrUFr9RskqKdi-Z5Isv-8eDW_6x6tlN2PNT/exec"; // Your Apps Script Web App URL

  // Define bins info: name, count vpin, reset vpin, sheet column name
  const bins = [
    { name: "TPS 1", countPin: "V1", resetPin: "V2", colHeader: "Jumlah Sampah TPS 1" },
    { name: "TPS 2", countPin: "V3", resetPin: "V4", colHeader: "Jumlah Sampah TPS 2" },
    { name: "TPS 3", countPin: "V5", resetPin: "V6", colHeader: "Jumlah Sampah TPS 3" },
    { name: "TPS 4", countPin: "V7", resetPin: "V8", colHeader: "Jumlah Sampah TPS 4" },
    { name: "TPS 5", countPin: "V9", resetPin: "V10", colHeader: "Jumlah Sampah TPS 5" }
  ];

  // Create cards for each bin
  const container = document.getElementById("binsContainer");
  bins.forEach((bin, i) => {
    const card = document.createElement("div");
    card.className = "card";
    card.id = `binCard${i}`;
    card.innerHTML = `
      <h2>${bin.name}</h2>
      <div class="count" id="count${i}">--</div>
      <button onclick="resetCounter('${bin.resetPin}', ${i})">Reset ${bin.name}</button>
      <button onclick="showHistory('${bin.colHeader}')">History ${bin.name}</button>
    `;
    container.appendChild(card);
  });

  // Fetch current counts for all bins
  async function fetchAllCounts() {
    bins.forEach(async (bin, i) => {
      try {
        const res = await fetch(`${API_URL}/?action=getCount&vpin=${bin.countPin}`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const count = await res.text();
        document.getElementById(`count${i}`).innerText = count || "0";
      } catch (err) {
        console.error(`Fetch error for ${bin.name}:`, err);
        document.getElementById(`count${i}`).innerText = "Error";
      }
    });
  }

  // Reset counter for a specific bin
  async function resetCounter(resetPin, index) {
    const password = prompt("Enter admin password:");
    if (!password) return;
    try {
      const res = await fetch(`${API_URL}/?action=resetCount&key=${encodeURIComponent(password)}&vpin=${resetPin}`);
      if (res.status === 401) {
        alert("Wrong password!");
      } else if (!res.ok) {
        throw new Error(`HTTP ${res.status}`);
      } else {
        alert(`Counter reset for ${bins[index].name}!`);
        fetchAllCounts();
      }
    } catch (err) {
      console.error("Reset error:", err);
      alert("Failed to reset counter.");
    }
  }

  // Cache history data
  let cachedHistory = null;
  async function fetchFullHistory() {
    if (cachedHistory) return cachedHistory;
    try {
      const res = await fetch(SHEET_API_URL);
      if (!res.ok) throw new Error(`HTTP error ${res.status}`);
      cachedHistory = await res.json();
      return cachedHistory;
    } catch (err) {
      console.error("Failed to fetch history:", err);
      return null;
    }
  }

  // Show history table for a bin
  async function showHistory(binColumn) {
    const data = await fetchFullHistory();
    if (!data) {
      document.getElementById("history").innerText = "Failed to load history";
      return;
    }
    let html = `<h2>History for ${binColumn}</h2>`;
    html += `<table><thead><tr><th>Tanggal</th><th>${binColumn}</th></tr></thead><tbody>`;
    data.forEach(row => {
      // Convert ISO date string to YYYY-MM-DD format
      function formatDate(isoString) {
        if (!isoString) return "";
        const d = new Date(isoString);
        if (isNaN(d)) return isoString; // fallback if not parseable
        // Format as YYYY-MM-DD
        const year = d.getFullYear();
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const day = String(d.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      }
    });
    html += `</tbody></table>`;
    document.getElementById("history").innerHTML = html;
  }

  // Update counts every 3 seconds
  setInterval(fetchAllCounts, 3000);
  fetchAllCounts();

</script>
</body>
</html>

